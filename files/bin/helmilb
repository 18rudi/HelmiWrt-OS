
#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Add USB Hilink, Ethernet, QMI Modem Interface by default
# Add my Load Balance network interfaces to default network config
if ! grep -q 'ueth1' /etc/config/network; then
	cat << "EOF" >> /etc/config/network

config interface 'l2tp'
	option proto 'l2tp'
	option ipv6 'auto'
	option auto '0'
	option metric '2'

config interface 'umd1'
	option proto 'modemmanager'
	option force_link '1'
	option apn 'aha'
	option auth 'none'
	option iptype 'ipv4'

config interface 'xderm'
	option proto 'none'
	option ifname 'tun0'
	option auto '0'

config interface 'libernet'
	option proto 'none'
	option ifname 'tun1'
	option auto '0'

config interface '3g'
	option proto '3g'
	option ipv6 'auto'
	option metric '3'

config interface 'wg1'
	option proto 'wireguard'
	option auto '0'
	option metric '4'

config interface 'ueth1'
	option proto 'dhcp'
	option ifname 'eth1'
	option metric '10'

config interface 'ueth2'
	option proto 'dhcp'
	option ifname 'eth2'
	option metric '20'

config interface 'ueth3'
	option proto 'dhcp'
	option ifname 'eth3'
	option metric '30'

config interface 'ueth4'
	option proto 'dhcp'
	option ifname 'eth4'
	option metric '40'

EOF
	logger "  helmilog : network interfaces for mwan3 loadbalance added..."
	echo -e "  helmilog : network interfaces for mwan3 loadbalance added..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Add my Load Balance network interfaces to firewall
if ! grep -q 'fweth' /etc/config/firewall; then
	cat << "EOF" >> /etc/config/firewall


config zone
	option name 'libernet'
	option masq '1'
	option mtu_fix '1'
	option input 'REJECT'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'libernet'

config forwarding
	option dest 'libernet'
	option src 'lan'

config forwarding
	option dest 'wan'
	option src 'libernet'

config zone
	option output 'ACCEPT'
	option name 'xderm'
	option input 'REJECT'
	option forward 'REJECT'
	option masq '1'
	option mtu_fix '1'
	option network 'xderm'

config forwarding
	option dest 'xderm'
	option src 'lan'

config forwarding
	option dest 'wan'
	option src 'xderm'

config zone
	option name 'ipsec'
	option input 'ACCEPT'
	option output 'ACCEPT'
	option forward 'REJECT'
	option masq '1'
	option mtu_fix '1'
	option network 'l2tp'

config forwarding
	option src 'lan'
	option dest 'ipsec'

config forwarding
	option src 'ipsec'
	option dest 'wan'

config zone
	option name 'fw3g'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network '3g'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config forwarding
	option dest 'fw3g'
	option src 'lan'

config zone
	option name 'fwumd1'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'umd1'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config forwarding
	option dest 'fwumd1'
	option src 'lan'

config zone
	option name 'fweth1'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth1'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config forwarding
	option dest 'fweth1'
	option src 'lan'

config zone
	option name 'fweth2'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth2'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config forwarding
	option dest 'fweth2'
	option src 'lan'

config zone
	option name 'fweth3'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth3'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config forwarding
	option dest 'fweth3'
	option src 'lan'

config zone
	option name 'fweth4'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth4'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config forwarding
	option dest 'fweth4'
	option src 'lan'

config forwarding
	option dest 'wan'
	option src 'lan'

EOF
	sed -i "s#list network 'wan'#list network 'wan'\n	list network 'wan6'\n	list network 'wg1'#g" /etc/config/firewall
	sed -i "s#wan wan6#wan wan6 wg1#g" /etc/config/firewall
	logger "  helmilog : firewall for mwan3 loadbalance added..."
	echo -e "  helmilog : firewall for mwan3 loadbalance added..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Add my Load Balance settings to default config mwan3
if ! grep -q 'mueth' /etc/config/mwan3; then
	cat << "EOF" > /etc/config/mwan3
config globals 'globals'
	option mmx_mask '0x3F00'
	option rtmon_interval '5'

config policy 'balanced'
	option last_resort 'default'
	option last_resort 'unreachable'
	list use_member 'm3g'
	list use_member 'mumd1'
	list use_member 'mueth1'
	list use_member 'mueth2'
	list use_member 'mueth3'
	list use_member 'mueth4'

config rule 'default_rule'
	option dest_ip '0.0.0.0/0'
	option use_policy 'balanced'
	option proto 'all'

config interface '3g'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'umd1'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'ueth1'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'ueth2'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'ueth3'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'ueth4'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config member 'm3g'
	option interface '3g'
	option metric '1'
	option weight '1'

config member 'mumd1'
	option interface 'umd1'
	option metric '1'
	option weight '1'

config member 'mueth1'
	option interface 'ueth1'
	option metric '1'
	option weight '1'

config member 'mueth2'
	option interface 'ueth2'
	option metric '1'
	option weight '1'

config member 'mueth3'
	option interface 'ueth3'
	option metric '1'
	option weight '1'

config member 'mueth4'
	option interface 'ueth4'
	option metric '1'
	option weight '1'

EOF
	echo "  helmilb_log : patching mwan3 done..."
	logger "  helmilog : mwan3 config file added..."
	echo -e "  helmilog : mwan3 config file added..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------