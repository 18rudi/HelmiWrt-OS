#!/bin/bash
#--------------------------------------------------------
#   Don't remove this section for credits
#   Don't rename this file
#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
#   My command lists
#   by Helmi Amirudin a.k.a helmiau
#   my profile page https://wwww.helmiau.com
#   my github https://github.com/helmiau
#--------------------------------------------------------

#--- Warna Warna
R='\033[1;31m' # Merah Muda
G='\033[1;32m' # Hijau Muda
C='\033[0;36m' # Biru Muda
Y='\033[1;33m' # Kuning
N='\033[1;37m' # Putih

#--- HelmiWrt command lists
echo -e "${R}======================================================"
echo -e "       ${Y}HelmiWrt Command lists by Helmi Amirudin"
echo -e "            ${Y}Copyright(R)2021 â€¢ helmiau.com"
echo -e "${R}======================================================${N}"
echo -e "  helmilb     : Install helmiau loadbalance 4 USB ISP."
echo -e "  ram         : Check ram usage and running apps."
echo -e "  sambaset    : Add USER samba as Allowed Guest."
echo -e "  fixphp      : Fix download index.php xderm/libernet."
echo -e "  myip        : Check your public IP Address Info."
echo -e "  ipqmi       : Refresh IP Address for QMI Modems."
echo -e "  vmess       : Free vmess account for 3 days."
echo -e "  ipv6-helper : This tool help you install IPV6 modules."
echo -e "  ocsm        : OpenClash Script Manager."
echo -e "  vasm        : v2rayA Script Manager."
echo -e "${R}======================================================"

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Set auto as default language
if grep -q "option lang 'zh" /etc/config/luci; then
	logger "  helmilog : chinese language detected !..."
	uci set luci.main.lang=auto
	uci commit luci
	logger "  helmilog : switched default languange to auto..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Autofix download index.php
if ! grep -q ".php=/usr/bin/php-cgi" /etc/config/uhttpd; then
	echo -e "  helmilog : system not using php-cgi, patching php config ..."
	logger "  helmilog : system not using php-cgi, patching php config..."
	helmiooo=$(cat /etc/config/uhttpd)
	if [[ $helmiooo == *"uhttpd 'mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 1 ..."
		logger "  helmilog : fixing auto download php file using patch 1 ..."
		sed -i "/config uhttpd 'main'/a list interpreter '.php=/usr/bin/php-cgi'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd 'mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 2 ..."
		logger "  helmilog : fixing auto download php file using patch 2 ..."
		sed -i "/config uhttpd 'main'/a option ubus_prefix '/ubus'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 3 ..."
		logger "  helmilog : fixing auto download php file using patch 3 ..."
		sed -i "/config uhttpd main/a list interpreter '.php=/usr/bin/php-cgi'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 4 ..."
		logger "  helmilog : fixing auto download php file using patch 4 ..."
		sed -i "/config uhttpd main/a option ubus_prefix '/ubus'" /etc/config/uhttpd
	fi
	echo -e "  helmilog : patching system with php configuration done ..."
	echo -e "  helmilog : restarting some apps ..."
	logger "  helmilog : patching system with php configuration done..."
	logger "  helmilog : restarting some apps..."
	/etc/init.d/uhttpd restart
	/etc/init.d/rpcd restart
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Add HelmiWrt firmware informations
if [ -f /etc/openwrt_release ]; then
	if ! grep -q Helmi /etc/openwrt_release;then
		logger "  helmilog : openwrt_release file available, patching..."
		sed -i -e 's/openwrt/HelmiWrt/iIg' -i -e 's/snapshot/Dev/iIg' /etc/openwrt_release
		logger "  helmilog : patching openwrt_release done..."
	fi
else
	logger "helmilog : /etc/openwrt_release file is not exist..."
fi
if [ -f /usr/lib/os-release ]; then
	if ! grep -q Helmi /usr/lib/os-release;then
		logger "  helmilog : os-release file available, patching..."
		sed -i -e 's/"openwrt/"helmiwrt/g' -i -e 's/openwrt"/helmiwrt"/g' -i -e 's/"OpenWrt/"HelmiWrt/g' -i -e 's/"snapshot/"Dev/g' -i -e 's/"SNAPSHOT/"Dev/g' -i -e 's/ SNAPSHOT/ Dev/g' -i -e 's#openwrt.org/#www.helmiau.com/blog/helmiwrt-os#g' -i -e 's#bugs.##g' -i -e 's#forum.##g' /usr/lib/os-release
		logger "  helmilog : patching os-release done..."
	fi
else
	logger "helmilog : os-release file is not exist..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Patch OpenClash codes
if ! grep -q "helmiwrt" /usr/lib/lua/luci/view/openclash/status.htm; then
	sed -i '/<img id="logo"/c\<img id="logo" src="/luci-static/helmiwrt/clashpremium.svg" title="Clash Premium for HelmiWrt" alt="Clash Premium for HelmiWrt" width="50%" onclick="return helmiwrt()" />' /usr/lib/lua/luci/view/openclash/status.htm
	sed -i "s#function homepage#function helmiwrt(){ url99='https://www.helmiau.com/blog/helmiwrt-os'; winOpen(url99); }\n\nfunction homepage#g" /usr/lib/lua/luci/view/openclash/status.htm
	logger "  helmilog : Clash Premium Patched..."
	echo -e "  helmilog : Clash Premium Patched..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Patch System Status
if ! grep -q "helmiwrt" /usr/lib/lua/luci/view/admin_status/index.htm; then
	sed -i 's$<h2 name="content"><%:Status%></h2>$<!--<h2 name="content"><%:Status%></h2>-->$g' /usr/lib/lua/luci/view/admin_status/index.htm
	sed -i '/%:System%/c\	<!--<legend><%:System%></legend>-->\n	<br><center><img height="70px" width="80%" src="/luci-static/helmiwrt/helmiwrtos.svg" ></center><br><br>' /usr/lib/lua/luci/view/admin_status/index.htm
	sed -i 's$<%=pcdata(ver.distversion)%> /$<%=pcdata(ver.distversion)%>$g' /usr/lib/lua/luci/view/admin_status/index.htm
	sed -i 's$<%=pcdata(ver.luciname)%> (<%=pcdata(ver.luciversion)%>)$</td></tr><tr><td width="33%"><%:LuCI Version%></td><td><%=pcdata(ver.luciname)%> (<%=pcdata(ver.luciversion)%>)</td></tr>$g' /usr/lib/lua/luci/view/admin_status/index.htm
	sed -i 's$<%=unameinfo.release or "?"%>$<%=unameinfo.release or "?"%>-HWOS$g' /usr/lib/lua/luci/view/admin_status/index.htm
	logger "  helmilog : System Status Patched..."
	echo -e "  helmilog : System Status Patched..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Patching Interfaces
if ! grep -q "helmiwrt" /usr/lib/lua/luci/view/themes/bootstrap/header.htm; then
	#patching favicon
	sed -i 's$<%=media%>/favicon.ico$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "<%=media%>" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/logo.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	#khususon argon
	sed -i 's$<%=media%>/icon/apple-icon-60x60.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/apple-icon-72x72.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/apple-icon-144x144.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/android-icon-192x192.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/favicon-32x32.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/favicon-96x96.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/favicon-16x16.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	#patching brand
	sed -i '/class="brand"/c\<img class="brand" src="/luci-static/helmiwrt/helmiwrtos.svg">' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes")
	sed -i '/netgear/c\<img class="brand" src="/luci-static/helmiwrt/helmiwrtos.svg" style="padding-left:10px; ! important;" >' $(grep -rli "helmiwrt" "/usr/lib/lua/luci/view/themes/netgear")
	sed -i 's$helmiwrtos.svg"$helmiwrtos.svg" height="25rem"$g' $(grep -rli "helmiwrtos" "/usr/lib/lua/luci/view/themes/argon")
	sed -i '/class="brand-text/c\<!--HelmiWrt-->' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/argon")
	sed -i 's$helmiwrtos.svg"$helmiwrtos-r.svg" height="30rem"$g' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/material")
	sed -i 's$src="/luci-static/helmiwrt/helmiwrtos.svg"$src="/luci-static/helmiwrt/helmiwrtos-r.svg" height="20rem"$g' $(grep -rli "helmiwrtos" "/usr/lib/lua/luci/view/themes/bootstrap")
	sed -i '/class="brand"/c\<img class="brand" src="/luci-static/helmiwrt/helmiwrtos-r.svg" height="25rem">' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/opentopd")
	sed -i '/class="brand"/c\<img class="brand" src="/luci-static/helmiwrt/helmiwrtos-r.svg" height="10rem" style="padding-left:10px; ! important;" >' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/atmaterial" "/usr/lib/lua/luci/view/themes/atmaterial_Brown" "/usr/lib/lua/luci/view/themes/atmaterial_red")
	sed -i 's$<%=media%>/logo.png$/luci-static/helmiwrt/helmiwrtos.svg$g	' $(grep -rli "logo.png" "/usr/lib/lua/luci/view/themes/edge")
	sed -i '/class="brand"/c\<a class="brand" href="#"><img src="/luci-static/helmiwrt/helmiwrtos.svg"></a>' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/edge")
	sed -i 's$helmiwrtos.svg"$helmiwrtos-r.svg" style="padding-left:10px; ! important;" $g' $(grep -rli "helmiwrtos" "/usr/lib/lua/luci/view/themes/opentomcat" "/usr/lib/lua/luci/view/themes/ifit" "/usr/lib/lua/luci/view/themes/opentomato")
	logger "  helmilog : User interfaces patched..."
	echo -e "  helmilog : User interfaces patched..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Configuring aria2
if ! grep -q "aria2" /etc/rc.local; then
	sed -i 's#exit 0#\n#g' /etc/rc.local
	cat << 'EOF' >> /etc/rc.local

aria2c --conf-path=/etc/aria2/aria2.conf --check-certificate=false --daemon=true --enable-rpc --rpc-allow-origin-all
usbipd -D &
sleep 1
usbip bind -b 2-2
exit 0
EOF
	logger "  helmilog : Aria2 configuration patched..."
	echo -e "  helmilog : Aria2c configuration patched..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# HelmiWrt Patches
if ! grep -q "helmiwrt" /etc/rc.local; then
	sed -i 's#exit 0#\n#g' /etc/rc.local
	cat << 'EOF' >> /etc/rc.local

chmod +x /bin/helmiwrt
/bin/helmiwrt
exit 0
EOF
	logger "  helmilog : helmiwrt already applied to on-boot..."
	echo -e "  helmilog : helmiwrt already applied to on-boot..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Set default theme
if [[ -s /bin/default-theme ]]; then
	if ! grep -q "mediaurlbase '/luci-static/netgear'" /etc/config/luci; then
		/bin/default-theme
		rm /bin/default-theme
		logger "  helmilog : default theme set..."
		echo -e "  helmilog : default theme set..."
	fi
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Skip confirmation screen when start speedtest
if [ ! -d /root/.config/ookla ]; then
	mkdir -p /root/.config/ookla;
	cat << 'EOF' > /root/.config/ookla/speedtest-cli.json
{
    "Settings": {
        "LicenseAccepted": "604ec27f828456331ebf441826292c49276bd3c1bee1a2f65a6452f505c4061c"
    }
}
EOF
	logger "  helmilog : speedtest patched..."
	echo -e "  helmilog : speedtest patched..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Add reboot, poweroff, shutdown, shadowsocksr++ restart/stop, mwan3 restart to LuCI -> System -> Custom Command
if ! grep -q "Shutdown" /etc/config/luci; then
	cat << "EOF" >> /etc/config/luci

config command
	option name 'Shutdown'
	option command 'halt'

config command
	option name 'Power Off'
	option command 'poweroff'

config command
	option name 'Reboot'
	option command 'reboot'

config command
	option name 'ShadowsocksR Restart'
	option command '/etc/init.d/shadowsocksr restart'

config command
	option name 'ShadowsocksR Stop'
	option command '/etc/init.d/shadowsocksr stop'

config command
	option name 'Restart Load Balance'
	option command 'mwan3 restart'

EOF
	logger "  helmilog : LuCI power menu added..."
	echo -e "  helmilog : LuCI power menu added..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# LuCI -> System -> Terminal (a.k.a) luci-app-ttyd without login
if ! grep -q "/bin/login -f root" /etc/config/ttyd; then
	cat << "EOF" > /etc/config/ttyd

config ttyd
	option interface '@lan'
	option command '/bin/login -f root'

EOF
	logger "  helmilog : Terminal ttyd patched..."
	echo -e "  helmilog : Terminal ttyd patched..."
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# QMI modem reconnect interface without reboot /lib/netifd/proto/qmi.sh
# source docs.google.com/document/d/10ldzikC9EdvXT43LEtct0qSwi5qWJk-LHFZFsl8_69E
if [ -f /lib/netifd/proto/qmi.sh ];then
	if ! grep -q "helmiau" /lib/netifd/proto/qmi.sh;then
		sed -i 's$local uninitialized_timeout=0$local uninitialized_timeout=0\n#------ Patched by Helmi Amirudin a.k.a helmiau------\n		helmiau1\n		helmiau2\n		helmiau3\n#------ Patched by Helmi Amirudin a.k.a helmiau ------$g' /lib/netifd/proto/qmi.sh
		sed -i 's#helmiau1#uqmi -s -d "$ device" --get-pin-status \&#g' /lib/netifd/proto/qmi.sh
		sed -i 's#helmiau2#sleep 3#g' /lib/netifd/proto/qmi.sh
		sed -i 's#helmiau3#killall uqmi || echo "UQMI works fine!"#g' /lib/netifd/proto/qmi.sh
		logger "  helmilog : QMI scripts patched..."
		echo -e "  helmilog : QMI scripts patched..."
	fi
fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Auto mount rw/read-write for ro/read-only partitions
# These lines below, must be written at the last script
if grep "[[:space:]]ro[[:space:],]" /proc/mounts; then
	logger "  helmilog : rootfs partition is read-only..."
	logger "  helmilog : mounting read-write..."
	logger "  helmilog : device will reboot after patching..."
	echo -e "  helmilog : rootfs partition is read-only..."
	echo -e "  helmilog : dmounting read-write..."
	echo -e "  helmilog : device will reboot after patching..."
	e2fsck -y /dev/mmcblk0p2
	logger "  helmilog : patching read-write done..."
	echo -e "  helmilog : patching read-write done..."
fi
