#!/bin/bash
#--------------------------------------------------------
#   Don't remove this section for credits
#   Don't rename this file
#--------------------------------------------------------
#   This script is used to install Xderm Mini GUI custom theme
#   Installation script by helmiau a.k.a Helmi Amirudin
#   my profile page https://me.helmiau.my.id
#   my github https://github.com/helmiau
#--------------------------------------------------------

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
CFGMWAN="/etc/config/mwan3"
CFGNET="/etc/config/network"
CFGFW="/etc/config/firewall"

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
echo "==========================================="
echo -e "   Current total USB interface : $(( $(grep -c mueth $CFGMWAN) / 2 ))"
echo "==========================================="
echo ""
echo "   Enter loadbalance inteface you want to create?"
echo "   Enter Your Option : 1~99"
echo ""
echo "==========================================="  

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
function helmilb_main() {

	if [[ $(grep -c 'mueth1' $CFGMWAN) = "0" ]];then
	echo "  helmilb_log : my load balance settings is not available, patching..."
	cat << "EOF" > $CFGMWAN
config rule 'default_rule'
	option dest_ip '0.0.0.0/0'
	option use_policy 'balanced'

config globals 'globals'
	option mmx_mask '0x3F00'
	option rtmon_interval '5'
	option local_source 'none'

config policy 'balanced'
	option last_resort 'unreachable'
	list use_member 'mueth1'
	list use_member 'wwan'

config interface 'ueth1'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'wwan'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'
	option enabled '0'

config member 'mueth1'
	option interface 'ueth1'
	option metric '1'
	option weight '1'

config member 'mwwan'
	option interface 'wwan'
	option metric '1'
	option weight '1'

EOF
		echo "  helmilb_log : patching main mwan3 done..."
	else
		echo "  helmilb_log : mwan3 config file already patched. Skipping..."
	fi


#patching firewall
	if [[ $(grep -c 'fweth1' $CFGFW) = "0" ]];then
	echo "  helmilb_log : firewall config file available, patching..."
	cat << "EOF" >> $CFGFW

config zone
	option name 'fweth1'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth1'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config forwarding
	option dest 'fweth1'
	option src 'lan'

config forwarding
	option dest 'wan'
	option src 'lan'

EOF
		echo "  helmilb_log : patching firewall config file done..."
	else
		echo "  helmilb_log : firewall config file already patched. Skipping..."
	fi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
# Add my Load Balance network interfaces to default network config
	if [[ $(grep -c 'ueth1' $CFGNET) = "0" ]] && [[ $(grep -c 'wwan' $CFGNET) = "0" ]];then
	echo "  helmilb_log : network config file available, patching..."
	cat << "EOF" >> $CFGNET

config interface 'ueth1'
	option proto 'dhcp'
	option ifname 'eth1'
	option metric '10'

config interface 'wwan'
	option proto 'dhcp'
	option metric '1000'

EOF
		echo "  helmilb_log : patching wwan network with $METRIC is done..."
	else
		echo "  helmilb_log : network config file already patched. Skipping..."
	fi

}

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
function helmilb_multi() {

for i in {0..$ETH..1}
do

ETHOLD="eth$(( ${ETH} - 1 ))"
UETHOLD="ueth$(( ${ETH} - 1 ))"
FWETHOLD="fweth$(( ${ETH} - 1 ))"
MUETHOLD="mueth$(( ${ETH} - 1 ))"
METRICOLD="$(( ${ETH} * 10 - 10 ))"
ETHNEW="eth${ETH}"
UETHNEW="ueth${ETH}"
FWETHNEW="fweth${ETH}"
MUETHNEW="mueth${ETH}"
METRICNEW="$(( ${ETH} * 10 ))"
ETHZONE="$(( ${ETH} + 3 ))"

	#Configuration of mwan3 config
	if [[ $(grep -c -q $MUETHOLD $CFGMWAN) = "0" ]] && [[ $(grep -c -q $UETHOLD $CFGMWAN) = "0" ]];then
		echo "  helmilb_log : $UETHOLD interface is not available, please create $UETHOLD first. Skipping..."
	elif [[ $(grep -c -q $MUETHNEW $CFGMWAN) = "0" ]] && [[ $(grep -c -q $UETHNEW $CFGMWAN) = "0" ]];then
		#Add new interface under -config policy 'balanced'- inside mwan3
		echo "  helmilb_log : Adding $MUETHNEW and $UETHNEW interface, patching..."
		sed -i "s/use_member '$MUETHOLD'/use_member '$MUETHOLD'\n	list use_member '$MUETHNEW'/g"  $CFGMWAN
		echo "  helmilb_log : patching $MUETHNEW and $UETHNEW interface mwan3 done..."
		#Add config interface 'interfacename'
		echo "  helmilb_log : Adding interface $UETHNEW configuration..."
		IFACE="config interface '$UETHOLD'\n	option enabled '1'\n	option initial_state 'online'\n	list track_ip '0.0.0.0'\n	option family 'ipv4'\n	option track_method 'ping'\n	option reliability '1'\n	option check_quality '0'\n	option keep_failure_interval '1'\n	option timeout '5'\n	option interval '3'\n	option failure_interval '3'\n	option recovery_interval '1'\n 	option down '5'\n	option up '5'\n	option count '4'\n	option size '24'\n\nconfig interface '$UETHNEW'"
		sed -i "s/config interface '$UETHOLD'/$IFACE/g"  $CFGMWAN
		echo "  helmilb_log : Config interface $UETHNEW patched. Done..."
		#Add interface weight 'interfacename'
		echo "  helmilb_log : Setting up interface weight for $UETHNEW..."
		WEIGHT="config member '$MUETHOLD'\n	oldinterface\n	option metric '1'\n	option weight '1'\n\nconfig member '$MUETHNEW'\n	option interface '$UETHNEW'"
		sed -i "s/config member '$MUETHOLD'/$WEIGHT/g"  $CFGMWAN
		sed -i "s/option interface '$UETHOLD'/hilangs/g"  $CFGMWAN
		sed -i "s/oldinterface/option interface '$UETHOLD'/g"  $CFGMWAN
		sed -i '/hilangs/d' $CFGMWAN
		echo "  helmilb_log : Setup weight for interface $UETHNEW done..."
	else
		echo "  helmilb_log : $UETHNEW interface is available. Skipping..."
	fi

	#Configuration of network config
	if [[ $(grep -c -q $ETHOLD $CFGNET) = "0" ]] && [[ $(grep -c -q $UETHOLD $CFGNET) = "0" ]];then
		echo "  helmilb_log : $UETHOLD interface is not available, please create $UETHOLD first. Skipping..."
	elif [[ $(grep -c -q $ETHNEW $CFGNET) = "0" ]] && [[ $(grep -c -q $UETHNEW $CFGNET) = "0" ]];then
		#Add new interface under -config policy 'balanced'- inside network
		echo "  helmilb_log : Adding $UETHNEW with $ETHNEW interface..."
		NET="option metric '$METRICOLD'\n\nconfig interface '$UETHNEW'\n	option proto 'dhcp'\n	option ifname '$ETHNEW'\n	option metric '$METRICNEW'\n"
		sed -i "s/option metric '$METRICOLD'/$NET/g" $CFGNET
		echo "  helmilb_log : patching $ETHNEW and $UETHNEW network interface done..."
	else
		echo "  helmilb_log : $UETHNEW interface is available. Skipping..."
	fi
	
	
	#Configuration of firewall config
	if [[ $(grep -c -q $UETHOLD $CFGFW) = "0" ]] && [[ $(grep -c -q $FWETHOLD $CFGFW) = "0" ]];then
		echo "  helmilb_log : $UETHOLD interface is not available, please create $UETHOLD first. Skipping..."
	elif [[ $(grep -c -q $UETHNEW $CFGFW) = "0" ]] && [[ $(grep -c -q $FWETHNEW $CFGFW) = "0" ]];then
		#Add new interface under -config policy 'balanced'- inside firewall
		echo "  helmilb_log : Adding $UETHNEW interface under $FWETHNEW firewall, patching..."
		#Configuration of firewall config
		FWADD="\nconfig zone\n	option name '$FWETHNEW'\n	option forward 'REJECT'\n	option output 'ACCEPT'\n	option network '$UETHNEW'\n	option input 'REJECT'\n	option masq '1'\n	option mtu_fix '1'\n\nconfig forwarding\n	option dest '$FWETHNEW'\n	option src 'lan'\n"
		echo -e "$FWADD" >> $CFGFW
		#sed -i "s/nhelmiautambahin/$FWADD/g" $CFGFW
		
		echo "  helmilb_log : patching $ETHNEW, $UETHNEW and $FWETHNEW firewall done..."
	else
		echo "  helmilb_log : $UETHNEW interface is available. Skipping..."
	fi

done
}

helmilb_main \ &&
helmilb_multi

#--------------------------------------------------------
#   If you use some codes frome here, please give credit to www.helmiau.com
#--------------------------------------------------------
#/etc/init.d/mwan3 restart
#/etc/init.d/network restart
#/etc/init.d/firewall restart