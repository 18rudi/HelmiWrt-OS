#!/bin/bash
#--------------------------------------------------------
#   Don't remove this section for credits
#   Don't rename this file
#--------------------------------------------------------
#   This script change default language to auto
#   Installation script by helmiau a.k.a Helmi Amirudin
#   my profile page https://helmiau.com
#   my github https://github.com/helmiau
#--------------------------------------------------------

# Set auto as default language
if grep -q "option lang 'zh" /etc/config/luci; then
	logger "  helmilog : chinese language detected !..."
	uci set luci.main.lang=auto
	uci commit luci
	logger "  helmilog : switched default languange to auto..."
fi

# Autofix download index.php
if ! grep -q ".php=/usr/bin/php-cgi" /etc/config/uhttpd; then
	echo -e "  helmilog : system not using php-cgi, patching php config ..."
	logger "  helmilog : system not using php-cgi, patching php config..."
	helmiooo=$(cat /etc/config/uhttpd)
	if [[ $helmiooo == *"uhttpd 'mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 1 ..."
		logger "  helmilog : fixing auto download php file using patch 1 ..."
		sed -i "/config uhttpd 'main'/a list interpreter '.php=/usr/bin/php-cgi'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd 'mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 2 ..."
		logger "  helmilog : fixing auto download php file using patch 2 ..."
		sed -i "/config uhttpd 'main'/a option ubus_prefix '/ubus'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 3 ..."
		logger "  helmilog : fixing auto download php file using patch 3 ..."
		sed -i "/config uhttpd main/a list interpreter '.php=/usr/bin/php-cgi'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 4 ..."
		logger "  helmilog : fixing auto download php file using patch 4 ..."
		sed -i "/config uhttpd main/a option ubus_prefix '/ubus'" /etc/config/uhttpd
	fi
	echo -e "  helmilog : patching system with php configuration done ..."
	echo -e "  helmilog : restarting some apps ..."
	logger "  helmilog : patching system with php configuration done..."
	logger "  helmilog : restarting some apps..."
	/etc/init.d/uhttpd restart
	/etc/init.d/rpcd restart
fi

# Add HelmiWrt firmware informations
if [ -f /etc/openwrt_release ];then
	if [[ $(grep -c Helmi /etc/openwrt_release) = "0" ]];then
		logger "  helmilog : openwrt_release file available, patching..."
		sed -i -e 's/openwrt/HelmiWrt/iIg' -i -e 's/snapshot/Dev/iIg' /etc/openwrt_release
		logger "  helmilog : patching openwrt_release done..."
	else
		logger "helmilog : openwrt_release file already patched. Skipping..."
	fi
else
	logger "helmilog : /etc/openwrt_release file is not exist..."
fi
if [ -f /usr/lib/os-release ];then
	if [[ $(grep -c Helmi /usr/lib/os-release) = "0" ]];then
		logger "  helmilog : os-release file available, patching..."
		sed -i -e 's/"openwrt/"helmiwrt/g' -i -e 's/openwrt"/helmiwrt"/g' -i -e 's/"OpenWrt/"HelmiWrt/g' -i -e 's/"snapshot/"Dev/g' -i -e 's/"SNAPSHOT/"Dev/g' -i -e 's/ SNAPSHOT/ Dev/g' -i -e 's#openwrt.org/#www.helmiau.com/blog/openwrt-rpi#g' -i -e 's#bugs.##g' -i -e 's#forum.##g' /usr/lib/os-release
		logger "  helmilog : patching os-release done..."
	else
		logger "helmilog : os-release file already patched. Skipping..."
	fi
else
	logger "helmilog : os-release file is not exist..."
fi

# Auto mount rw/read-write for ro/read-only partitions
if [ grep "[[:space:]]ro[[:space:],]" /proc/mounts ];then
	logger "  helmilog : rootfs partition is read-only..."
	logger "  helmilog : mounting read-write..."
	logger "  helmilog : device will reboot after patching..."
	e2fsck -y /dev/mmcblk0p2
	logger "  helmilog : patching read-write done..."
fi
