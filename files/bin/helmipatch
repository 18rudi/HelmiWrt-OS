#!/bin/bash
#--------------------------------------------------------
#   Don't remove this section for credits
#   Don't rename this file
#--------------------------------------------------------
#   This script change default language to auto
#   Installation script by helmiau a.k.a Helmi Amirudin
#   my profile page https://helmiau.com
#   my github https://github.com/helmiau
#--------------------------------------------------------

# Set auto as default language
if grep -q "option lang 'zh" /etc/config/luci; then
	logger "  helmilog : chinese language detected !..."
	uci set luci.main.lang=auto
	uci commit luci
	logger "  helmilog : switched default languange to auto..."
fi

# Autofix download index.php
if ! grep -q ".php=/usr/bin/php-cgi" /etc/config/uhttpd; then
	echo -e "  helmilog : system not using php-cgi, patching php config ..."
	logger "  helmilog : system not using php-cgi, patching php config..."
	helmiooo=$(cat /etc/config/uhttpd)
	if [[ $helmiooo == *"uhttpd 'mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 1 ..."
		logger "  helmilog : fixing auto download php file using patch 1 ..."
		sed -i "/config uhttpd 'main'/a list interpreter '.php=/usr/bin/php-cgi'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd 'mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 2 ..."
		logger "  helmilog : fixing auto download php file using patch 2 ..."
		sed -i "/config uhttpd 'main'/a option ubus_prefix '/ubus'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 3 ..."
		logger "  helmilog : fixing auto download php file using patch 3 ..."
		sed -i "/config uhttpd main/a list interpreter '.php=/usr/bin/php-cgi'" /etc/config/uhttpd
	fi
	if [[ $helmiooo == *"uhttpd mai"* ]]; then
		echo -e "  helmilog : fixing auto download php file using patch 4 ..."
		logger "  helmilog : fixing auto download php file using patch 4 ..."
		sed -i "/config uhttpd main/a option ubus_prefix '/ubus'" /etc/config/uhttpd
	fi
	echo -e "  helmilog : patching system with php configuration done ..."
	echo -e "  helmilog : restarting some apps ..."
	logger "  helmilog : patching system with php configuration done..."
	logger "  helmilog : restarting some apps..."
	/etc/init.d/uhttpd restart
	/etc/init.d/rpcd restart
fi

# Add HelmiWrt firmware informations
if [ -f /etc/openwrt_release ];then
	if ! grep -q Helmi /etc/openwrt_release;then
		logger "  helmilog : openwrt_release file available, patching..."
		sed -i -e 's/openwrt/HelmiWrt/iIg' -i -e 's/snapshot/Dev/iIg' /etc/openwrt_release
		logger "  helmilog : patching openwrt_release done..."
	else
		logger "helmilog : openwrt_release file already patched. Skipping..."
	fi
else
	logger "helmilog : /etc/openwrt_release file is not exist..."
fi
if [ -f /usr/lib/os-release ];then
	if ! grep -q Helmi /usr/lib/os-release;then
		logger "  helmilog : os-release file available, patching..."
		sed -i -e 's/"openwrt/"helmiwrt/g' -i -e 's/openwrt"/helmiwrt"/g' -i -e 's/"OpenWrt/"HelmiWrt/g' -i -e 's/"snapshot/"Dev/g' -i -e 's/"SNAPSHOT/"Dev/g' -i -e 's/ SNAPSHOT/ Dev/g' -i -e 's#openwrt.org/#www.helmiau.com/blog/openwrt-rpi#g' -i -e 's#bugs.##g' -i -e 's#forum.##g' /usr/lib/os-release
		logger "  helmilog : patching os-release done..."
	else
		logger "helmilog : os-release file already patched. Skipping..."
	fi
else
	logger "helmilog : os-release file is not exist..."
fi

# Auto mount rw/read-write for ro/read-only partitions
if grep "[[:space:]]ro[[:space:],]" /proc/mounts; then
	logger "  helmilog : rootfs partition is read-only..."
	logger "  helmilog : mounting read-write..."
	logger "  helmilog : device will reboot after patching..."
	echo -e "  helmilog : rootfs partition is read-only..."
	echo -e "  helmilog : dmounting read-write..."
	echo -e "  helmilog : device will reboot after patching..."
	e2fsck -y /dev/mmcblk0p2
	logger "  helmilog : patching read-write done..."
	echo -e "  helmilog : patching read-write done..."
fi

# Patch OpenClash codes
if ! grep -q "helmiwrt" /usr/lib/lua/luci/view/openclash/status.htm; then
	sed -i '/<img id="logo"/c\<img id="logo" src="/luci-static/helmiwrt/clashpremium.svg" title="Clash Premium for HelmiWrt" alt="Clash Premium for HelmiWrt" width="50%" onclick="return helmiwrt()" />' /usr/lib/lua/luci/view/openclash/status.htm
	sed -i "s#function homepage#function helmiwrt(){ url99='https://www.helmiau.com/blog/openwrt-rpi'; winOpen(url99); }\n\nfunction homepage#g" /usr/lib/lua/luci/view/openclash/status.htm
	logger "  helmilog : Clash Premium Patched..."
	echo -e "  helmilog : Clash Premium Patched..."
fi

# Patch System Status
if ! grep -q "helmiwrt" /usr/lib/lua/luci/view/admin_status/index.htm; then
	sed -i '/%:System%/c\	<!--<legend><%:System%></legend>-->\n	<br><center><img height="70px" width="80%" src="/luci-static/helmiwrt/helmiwrtos.svg" ></center><br><br>' /usr/lib/lua/luci/view/admin_status/index.htm
	logger "  helmilog : System Status Patched..."
	echo -e "  helmilog : System Status Patched..."
fi

# Patching Interfaces
if ! grep -q "helmiwrt" /usr/lib/lua/luci/view/themes/bootstrap/header.htm; then
	#patching favicon
	sed -i 's$<%=media%>/favicon.ico$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "<%=media%>" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/logo.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	#khususon argon
	sed -i 's$<%=media%>/icon/apple-icon-60x60.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/apple-icon-72x72.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/apple-icon-144x144.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/android-icon-192x192.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/favicon-32x32.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/favicon-96x96.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	sed -i 's$<%=media%>/icon/favicon-16x16.png$/luci-static/helmiwrt/hwos.svg$g' $(grep -rli "hwos.svg" "/usr/lib/lua/luci/view/themes")
	#patching brand
	sed -i '/class="brand"/c\<img class="brand" src="/luci-static/helmiwrt/helmiwrtos.svg">' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes")
	sed -i '/netgear/c\<img class="brand" style="padding-left:10px; ! important;" src="/luci-static/helmiwrt/helmiwrtos.svg">' $(grep -rli "netgear" "/usr/lib/lua/luci/view/themes/netgear")
	sed -i 's$helmiwrtos.svg"$helmiwrtos.svg" height="25rem"$g' $(grep -rli "helmiwrtos" "/usr/lib/lua/luci/view/themes/argon")
	sed -i '/class="brand-text/c\<!--HelmiWrt-->' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/argon")
	sed -i 's$helmiwrtos.svg"$helmiwrtos-r.svg" height="30rem"$g' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/material")
	sed -i 's$src="/luci-static/helmiwrt/helmiwrtos.svg"$src="/luci-static/helmiwrt/helmiwrtos-r.svg" height="20rem"$g' $(grep -rli "helmiwrtos" "/usr/lib/lua/luci/view/themes/bootstrap")
	sed -i '/class="brand"/c\<img class="brand" src="/luci-static/helmiwrt/helmiwrtos-r.svg" height="25rem">' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/opentopd")
	sed -i '/class="brand"/c\<img class="brand" src="/luci-static/helmiwrt/helmiwrtos-r.svg" height="10rem">' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/atmaterial" "/usr/lib/lua/luci/view/themes/atmaterial_Brown" "/usr/lib/lua/luci/view/themes/atmaterial_red")
	sed -i 's$<%=media%>/logo.png$/luci-static/helmiwrt/helmiwrtos.svg$g	' $(grep -rli "logo.png" "/usr/lib/lua/luci/view/themes/edge")
	sed -i '/class="brand"/c\<a class="brand" href="#"><img src="/luci-static/helmiwrt/helmiwrtos.svg"></a>' $(grep -rli "brand" "/usr/lib/lua/luci/view/themes/edge")
	sed -i 's$helmiwrtos.svg$helmiwrtos-r.svg$g' $(grep -rli "helmiwrtos" "/usr/lib/lua/luci/view/themes/opentomcat" "/usr/lib/lua/luci/view/themes/ifit" "/usr/lib/lua/luci/view/themes/opentomato")
	logger "  helmilog : User interfaces patched..."
	echo -e "  helmilog : User interfaces patched..."
fi

# Configuring aria2c
if ! grep -q "aria2c" /etc/rc.local; then
	sed -i 's#exit 0#\n#g' /etc/rc.local
	cat << 'EOF' >> /etc/rc.local

aria2c --conf-path=/etc/aria2/aria2.conf --check-certificate=false --daemon=true --enable-rpc --rpc-allow-origin-all
usbipd -D &
sleep 1
usbip bind -b 2-2
exit 0
EOF
	logger "  helmilog : Aria2 configuration patched..."
	echo -e "  helmilog : Aria2c configuration patched..."
fi

# HelmiWrt Patches
if ! grep -q "helmipatch" /etc/rc.local; then
	sed -i 's#exit 0#\n#g' /etc/rc.local
	cat << 'EOF' >> /etc/rc.local

chmod +x /bin/helmipatch
/bin/helmipatch
exit 0
EOF
	logger "  helmilog : helmipatch already applied to on-boot..."
	echo -e "  helmilog : helmipatch already applied to on-boot..."
fi
